<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级WFD默写教练</title>
    <!-- 引入Tailwind CSS 用于美化界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Lucide图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 自定义动画和样式 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .comparison-result span {
            padding: 4px 6px;
            border-radius: 4px;
            margin: 2px;
            display: inline-block;
            font-size: 1.1rem;
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .word-correct {
            background-color: #dcfce7;
            color: #166534;
        }

        .word-incorrect {
            background-color: #fee2e2;
            color: #991b1b;
            text-decoration: line-through;
        }

        .word-missing {
            background-color: #e0e7ff;
            color: #4338ca;
            border: 1px dashed #6366f1;
        }

        .word-extra {
            background-color: #fef9c3;
            color: #854d0e;
            border: 1px dashed #ca8a04;
        }

        .pulse-once {
            animation: pulse-animation 0.8s ease-out;
        }

        @keyframes pulse-animation {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(99, 102, 241, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }
        /* 倒计时样式 */
        #timer-display {
            transition: color 0.5s, transform 0.5s;
        }

            #timer-display.urgent {
                color: #dc2626;
                transform: scale(1.1);
            }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen font-sans">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl p-8 m-4">

        <div class="text-center border-b pb-4 mb-6">
            <h1 class="text-3xl font-extrabold text-slate-800">高级WFD默写教练</h1>
            <p class="text-slate-500 mt-2">调语速、练听写、带倒计时、智能纠错</p>
        </div>

        <!-- 控制区域 -->
        <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4 mb-6">
            <!-- 播放和题目控制 -->
            <div class="flex items-center justify-center md:justify-start gap-4">
                <button id="play-audio-btn" class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all transform hover:scale-105">
                    <i data-lucide="play-circle"></i><span>播放</span>
                </button>
                <button id="next-question-btn" class="flex items-center justify-center gap-2 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all transform hover:scale-105">
                    <span>下一题</span><i data-lucide="arrow-right-circle"></i>
                </button>
            </div>
            <!-- 速度和倒计时 -->
            <div class="flex items-center justify-center gap-6">
                <div class="flex items-center gap-2">
                    <i data-lucide="gauge-circle" class="text-slate-500"></i>
                    <label for="speed-control" class="text-slate-600 font-medium">语速:</label>
                    <input id="speed-control" type="range" min="0.7" max="1.3" value="0.9" step="0.1" class="w-24 cursor-pointer">
                    <span id="speed-value" class="font-bold text-indigo-600 w-8">0.9x</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="timer" class="text-slate-500"></i>
                    <span class="text-slate-600 font-medium">倒计时:</span>
                    <span id="timer-display" class="font-bold text-2xl text-slate-800 w-12 text-center">30</span>
                </div>
            </div>
            <!-- 题目计数 -->
            <div class="text-sm text-slate-500 text-center md:text-right">
                当前题目: <span id="current-question-index" class="font-bold">1</span> / <span id="total-questions" class="font-bold">0</span>
            </div>
        </div>

        <div class="mb-6">
            <textarea id="user-input" rows="4" class="w-full p-4 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 transition" placeholder="请在此处输入你听到的句子..."></textarea>
        </div>

        <button id="submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg text-lg shadow-xl transition-all transform hover:scale-105">
            提交答案并对比
        </button>

        <div id="result-container" class="mt-8 hidden fade-in">
            <div class="border-t pt-6">
                <h3 class="text-xl font-bold text-slate-700 mb-4">对比结果</h3>
                <div id="comparison-result" class="p-4 bg-slate-50 rounded-lg comparison-result"></div>
                <h3 class="text-xl font-bold text-slate-700 mt-6 mb-4">正确答案</h3>
                <div id="correct-answer" class="p-4 bg-slate-50 rounded-lg text-slate-800 font-semibold text-lg"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const wfdSentences = [
                { id: 1, sentence: "Please get us a meeting room for the next hour." },
                { id: 2, sentence: "Communication skills have become more important in recent years." },
                { id: 3, sentence: "Before preparing any food, be sure to wash your hands well." },
                { id: 4, sentence: "Before preparing food, please make sure to wash your hands." },
                { id: 5, sentence: "The weather has been lovely from this time of the year." },
                { id: 6, sentence: "Please close the door behind you when you leave the room." },
                { id: 7, sentence: "There was a lot of traffic this morning." },
                { id: 8, sentence: "The restroom is down the hall and on the right." },
                { id: 9, sentence: "The teacher explains the homework to the students." },
                { id: 10, sentence: "At that time, few people moved through the town to the village." },
                { id: 11, sentence: "The fiction books have just passed to the counter." },
                { id: 12, sentence: "You have to make an appointment with your doctor." },
                { id: 13, sentence: "The students will meet their new teacher after summer vacation." },
                { id: 14, sentence: "Please move us to the meeting room for the next hour." },
                { id: 15, sentence: "You must call your doctor to make an appointment." },
                { id: 16, sentence: "Please make an appointment with your tutor about work." },
                { id: 17, sentence: "Rail transport is becoming more and more popular." },
                { id: 18, sentence: "You can keep your bags in the back room." },
                { id: 19, sentence: "The weather used to be lovely at this time of the year." },
                { id: 20, sentence: "Everyone in this room needs to follow the rules." },
                { id: 21, sentence: "I want to make an appointment with the manager." },
                { id: 22, sentence: "The teacher explained the homework to the class." },
                { id: 23, sentence: "You should meet me in the lecture theater room." },
                { id: 24, sentence: "At that time, few people moved from towns to villages." },
                { id: 25, sentence: "Students of the first year usually live on campus." },
                { id: 26, sentence: "The fiction books are just past the counter." },
                { id: 27, sentence: "The teacher asked the group to complete the task." },
                { id: 28, sentence: "There was a lot of traffic jams on the road this morning." },
                { id: 29, sentence: "The school canteen sells a large variety of water and food." },
                { id: 30, sentence: "Please turn off the lights to save energy." },
                { id: 31, sentence: "Traffic is the main cause of air pollution in many cities." },
                { id: 32, sentence: "You will get your uniform on the first day." },
                { id: 33, sentence: "In my opinion, this car should be repaired soon." },
                { id: 34, sentence: "We should have a meeting to discuss and report." },
                { id: 35, sentence: "Sales figures for last year were better than expected." },
                { id: 36, sentence: "The university canteen offers different healthy meal options." },
                { id: 37, sentence: "Employment opportunities available in engineering are increasing rapidly." },
                { id: 38, sentence: "We cannot consider an increase in price at this stage." },
                { id: 39, sentence: "We should have a meeting to discuss the report." },
                { id: 40, sentence: "Our culture influences the choices we make." },
                { id: 41, sentence: "There will be a guest lecturer in the next class." },
                { id: 42, sentence: "Exam results will be published on the noticeboard." },
                { id: 43, sentence: "Atoms are the central building blocks of matter." },
                { id: 44, sentence: "There will be a meeting for the first-year students on Friday." },
                { id: 45, sentence: "The stairs are to the left of the elevator." },
                { id: 46, sentence: "Restrooms are down the entrance and to the right." },
                { id: 47, sentence: "Time is needed to complete the lecture." },
                { id: 48, sentence: "Restaurants are down to the hall and next to the right." },
                { id: 49, sentence: "Make sure you wash your hands before preparing the food." },
                { id: 50, sentence: "You should draw your graph on a separate page." },
                { id: 51, sentence: "You can ask your tutor for further assistance." },
                { id: 52, sentence: "You are trained to be a special journalist." },
                { id: 53, sentence: "We can have a lecture on the morning of Thursday." },
                { id: 54, sentence: "We can all meet in the office after the lecture." },
                { id: 55, sentence: "The digital revolution has changed the way we read." },
                { id: 56, sentence: "Before the refrigerator was invented, people used underground ice houses." },
                { id: 57, sentence: "The nation achieved prosperity by opening its ports for trade." },
                { id: 58, sentence: "Understanding visual media has never been more challenging." },
                { id: 59, sentence: "Online courses allow students to work on their own paces." },
                { id: 60, sentence: "In my opinion, this car should be repaired soon." },
                { id: 61, sentence: "You can get your coffee and tea in the lounge room." },
                { id: 62, sentence: "The teacher asked the group to commmence the task." },
                { id: 63, sentence: "The island is located at the south end of the bay." },
                { id: 64, sentence: "The falling birth rate means the number of students drops." },
                { id: 65, sentence: "Please click the logo above to enter the site." },
                { id: 66, sentence: "The camera can identify eyes and focus on them." },
                { id: 67, sentence: "This article refers to a number of interesting experiments." },
                { id: 68, sentence: "You should submit your team papers to the general office." },
                { id: 69, sentence: "All students have their own styles of learning." },
                { id: 70, sentence: "Stock prediction can be very capricious even for professionals." },
                { id: 71, sentence: "New classrooms will be put into use next month." },
                { id: 72, sentence: "You need to pass the written exam for the driver's license." }
            ];

            let currentQuestionIndex = 0;
            let synth = window.speechSynthesis;
            let utterance = new SpeechSynthesisUtterance();
            let voices = [];
            let timerInterval = null;
            let timeLeft = 30;

            const playAudioBtn = document.getElementById('play-audio-btn');
            const nextQuestionBtn = document.getElementById('next-question-btn');
            const submitBtn = document.getElementById('submit-btn');
            const userInput = document.getElementById('user-input');
            const resultContainer = document.getElementById('result-container');
            const comparisonResultDiv = document.getElementById('comparison-result');
            const correctAnswerDiv = document.getElementById('correct-answer');
            const currentQuestionIndexSpan = document.getElementById('current-question-index');
            const totalQuestionsSpan = document.getElementById('total-questions');
            const speedControl = document.getElementById('speed-control');
            const speedValueSpan = document.getElementById('speed-value');
            const timerDisplay = document.getElementById('timer-display');

            function initialize() {
                loadVoices();
                loadQuestion(currentQuestionIndex);
                totalQuestionsSpan.textContent = wfdSentences.length;

                if (synth.onvoiceschanged !== undefined) {
                    synth.onvoiceschanged = loadVoices;
                }
            }

            function loadVoices() {
                voices = synth.getVoices();
                const preferredVoice = voices.find(voice => voice.name === 'Google US English') || voices.find(voice => voice.lang === 'en-US');
                if (preferredVoice) utterance.voice = preferredVoice;
                utterance.pitch = 1;
                updateSpeechRate();
            }

            function loadQuestion(index) {
                stopTimer();
                const question = wfdSentences[index];
                utterance.text = question.sentence;
                userInput.value = '';
                userInput.disabled = false;
                resultContainer.classList.add('hidden');
                currentQuestionIndexSpan.textContent = index + 1;
                userInput.focus();
            }

            function startTimer() {
                stopTimer(); // Ensure no multiple timers run
                timeLeft = 30;
                timerDisplay.textContent = timeLeft;
                timerDisplay.classList.remove('urgent');

                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    if (timeLeft <= 10) {
                        timerDisplay.classList.add('urgent');
                    }
                    if (timeLeft <= 0) {
                        stopTimer();
                        submitBtn.click(); // Auto-submit when time is up
                    }
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
                timerInterval = null;
                timerDisplay.textContent = 30;
                timerDisplay.classList.remove('urgent');
            }

            function updateSpeechRate() {
                const rate = parseFloat(speedControl.value);
                utterance.rate = rate;
                speedValueSpan.textContent = `${rate.toFixed(1)}x`;
            }

            function compareAnswers() {
                stopTimer();
                userInput.disabled = true;
                const correctText = wfdSentences[currentQuestionIndex].sentence;
                const userText = userInput.value;
                const normalize = (text) => text.toLowerCase().replace(/[.,?!]/g, '').trim().split(/\s+/).filter(Boolean);
                const correctWords = normalize(correctText);
                const userWords = normalize(userText);
                const userWordStatus = userWords.map(() => 'extra');
                const correctWordMatched = correctWords.map(() => false);

                for (let i = 0; i < userWords.length; i++) {
                    for (let j = 0; j < correctWords.length; j++) {
                        if (!correctWordMatched[j] && userWords[i] === correctWords[j]) {
                            if (Math.abs(i - j) < 5) {
                                userWordStatus[i] = 'correct';
                                correctWordMatched[j] = true;
                                break;
                            }
                        }
                    }
                }

                for (let i = 0; i < userWords.length; i++) {
                    if (userWordStatus[i] === 'extra') {
                        let isIncorrect = false;
                        for (let j = 0; j < correctWords.length; j++) {
                            if (!correctWordMatched[j] && Math.abs(i - j) < 3) {
                                isIncorrect = true;
                                break;
                            }
                        }
                        if (isIncorrect) userWordStatus[i] = 'incorrect';
                    }
                }

                let finalResultHTML = '';
                let userIndex = 0;
                for (let i = 0; i < correctWords.length; i++) {
                    if (correctWordMatched[i]) {
                        while (userIndex < userWords.length) {
                            if (userWords[userIndex] === correctWords[i] && userWordStatus[userIndex] === 'correct') {
                                finalResultHTML += `<span class="word-correct">${userWords[userIndex]}</span>`;
                                userIndex++;
                                break;
                            } else if (userWordStatus[userIndex] !== 'correct') {
                                finalResultHTML += `<span class="word-${userWordStatus[userIndex]}">${userWords[userIndex]}</span>`;
                                userIndex++;
                            } else {
                                userIndex++;
                            }
                        }
                    } else {
                        finalResultHTML += `<span class="word-missing">${correctWords[i]} (遗漏)</span>`;
                    }
                }

                while (userIndex < userWords.length) {
                    finalResultHTML += `<span class="word-extra">${userWords[userIndex]}</span>`;
                    userIndex++;
                }

                comparisonResultDiv.innerHTML = finalResultHTML;
                correctAnswerDiv.textContent = correctText;
                resultContainer.classList.remove('hidden');
            }

            playAudioBtn.addEventListener('click', () => {
                if (synth.speaking) synth.cancel();
                playAudioBtn.classList.add('pulse-once');
                setTimeout(() => playAudioBtn.classList.remove('pulse-once'), 800);

                // Start timer when speech ends
                utterance.onend = () => {
                    startTimer();
                    userInput.focus();
                };

                synth.speak(utterance);
            });

            nextQuestionBtn.addEventListener('click', () => {
                currentQuestionIndex = (currentQuestionIndex + 1) % wfdSentences.length;
                loadQuestion(currentQuestionIndex);
            });

            speedControl.addEventListener('input', updateSpeechRate);

            submitBtn.addEventListener('click', compareAnswers);

            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitBtn.click();
                }
            });

            initialize();
        });
    </script>
</body>
</html>
