<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级WFD默写教练</title>
    <!-- 引入Tailwind CSS 用于美化界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Lucide图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 自定义动画和样式 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .comparison-result span {
            padding: 4px 6px;
            border-radius: 4px;
            margin: 2px;
            display: inline-block;
            font-size: 1.1rem;
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .word-correct {
            background-color: #dcfce7;
            color: #166534;
        }

        .word-incorrect {
            background-color: #fee2e2;
            color: #991b1b;
            text-decoration: line-through;
        }

        .word-missing {
            background-color: #e0e7ff;
            color: #4338ca;
            border: 1px dashed #6366f1;
        }

        .pulse-once {
            animation: pulse-animation 0.8s ease-out;
        }

        @keyframes pulse-animation {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(99, 102, 241, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        #timer-display {
            transition: color 0.5s, transform 0.5s;
        }

            #timer-display.urgent {
                color: #dc2626;
                animation: pulse-urgent 1s infinite;
            }

        @keyframes pulse-urgent {
            0%, 100% {
                transform: scale(1.1);
            }

            50% {
                transform: scale(1);
            }
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-start justify-center min-h-screen font-sans p-4">
    <div class="w-full max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- 主练习区 -->
        <div class="lg:col-span-2 w-full bg-white rounded-2xl shadow-2xl p-6 md:p-8">
            <div class="text-center border-b pb-4 mb-6">
                <h1 class="text-3xl font-extrabold text-slate-800">高级WFD默写教练</h1>
                <p class="text-slate-500 mt-2">智能识别多种答案、支持重练、带倒计时</p>
            </div>

            <!-- 控制区域 -->
            <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4 mb-6">
                <!-- 播放和题目控制 -->
                <div class="flex items-center justify-center md:justify-start gap-1 sm:gap-2">
                    <button id="play-audio-btn" title="播放" class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all transform hover:scale-105">
                        <i data-lucide="play-circle"></i><span class="hidden sm:inline">播放</span>
                    </button>
                    <button id="retry-btn" title="重来本题" class="flex items-center justify-center gap-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all transform hover:scale-105">
                        <i data-lucide="rotate-cw"></i><span class="hidden sm:inline">重来</span>
                    </button>
                    <button id="prev-question-btn" title="上一题" class="flex items-center justify-center gap-2 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all transform hover:scale-105">
                        <i data-lucide="arrow-left-circle"></i><span class="hidden sm:inline">上题</span>
                    </button>
                    <button id="next-question-btn" title="下一题" class="flex items-center justify-center gap-2 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all transform hover:scale-105">
                        <span class="hidden sm:inline">下题</span><i data-lucide="arrow-right-circle"></i>
                    </button>
                </div>
                <!-- 速度和倒计时 -->
                <div class="flex items-center justify-center gap-4 sm:gap-6">
                    <div class="flex items-center gap-2">
                        <i data-lucide="gauge-circle" class="text-slate-500"></i>
                        <label for="speed-control" class="text-slate-600 font-medium">语速:</label>
                        <input id="speed-control" type="range" min="0.7" max="1.3" value="1.0" step="0.1" class="w-20 sm:w-24 cursor-pointer">
                        <span id="speed-value" class="font-bold text-indigo-600 w-8">1.0x</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i data-lucide="timer" class="text-slate-500"></i>
                        <span class="text-slate-600 font-medium">倒计时:</span>
                        <span id="timer-display" class="font-bold text-2xl text-slate-800 w-12 text-center">30</span>
                    </div>
                </div>
                <!-- 题目计数 -->
                <div class="text-sm text-slate-500 text-center md:text-right">
                    当前题目: <span id="current-question-index" class="font-bold">1</span> / <span id="total-questions" class="font-bold">0</span>
                </div>
            </div>

            <div class="mb-6">
                <textarea id="user-input" rows="4" class="w-full p-4 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 transition" placeholder="请在此处输入你听到的句子..."></textarea>
            </div>

            <button id="submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg text-lg shadow-xl transition-all transform hover:scale-105">
                提交答案并对比
            </button>

            <div id="result-container" class="mt-8 hidden fade-in">
                <div class="border-t pt-6">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-slate-700">你的得分</h3>
                        <p class="text-6xl font-extrabold text-indigo-600 mt-2">
                            <span id="score-display">0</span> / <span id="total-score-display">0</span>
                        </p>
                    </div>
                    <h3 class="text-xl font-bold text-slate-700 mb-4">对比结果</h3>
                    <div id="comparison-result" class="p-4 bg-slate-50 rounded-lg comparison-result"></div>
                    <h3 class="text-xl font-bold text-slate-700 mt-6 mb-4">正确答案</h3>
                    <div id="correct-answer" class="p-4 bg-slate-50 rounded-lg text-slate-800 font-semibold text-lg"></div>
                </div>
            </div>

            <footer class="text-center text-slate-400 text-sm mt-8 pt-4 border-t">
                &copy; <span id="copyright-year"></span> pte9999. All Rights Reserved.
            </footer>
        </div>
        <!-- (新增!) 练习历史面板 -->
        <div class="w-full bg-white rounded-2xl shadow-2xl p-6 md:p-8 lg:sticky lg:top-8">
            <div class="text-center border-b pb-4 mb-4">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center justify-center gap-2"><i data-lucide="history"></i>练习历史</h2>
            </div>
            <div id="history-list-container" class="h-96 lg:h-[calc(100vh-12rem)] overflow-y-auto pr-2">
                <ul id="history-list" class="space-y-3">
                    <!-- 历史记录将通过JS动态插入这里 -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const wfdSentences = [
                // ... (Your 72 sentences are here) ...
                { id: 1, sentence: ["Please get us a meeting room for the next hour."] },
                { id: 2, sentence: ["Communication skills have become more important in recent years."] },
                { id: 3, sentence: ["Before preparing any food, be sure to wash your hands well."] },
                { id: 4, sentence: ["Before preparing food, please make sure to wash your hands."] },
                { id: 5, sentence: ["The weather has been lovely from this time of the year."] },
                { id: 6, sentence: ["Please close the door behind you when you leave the room."] },
                { id: 7, sentence: ["There was a lot of traffic this morning."] },
                { id: 8, sentence: ["The restroom is down the hall and on the right.", "The restrooms are down the hall to the right."] },
                { id: 9, sentence: ["The teacher explains the homework to the students."] },
                { id: 10, sentence: ["At that time, few people moved through the town to the village.", "At that time, few people moved from towns to villages."] },
                { id: 11, sentence: ["The fiction books have just passed to the counter."] },
                { id: 12, sentence: ["You have to make an appointment with your doctor."] },
                { id: 13, sentence: ["The students will meet their new teacher after summer vacation."] },
                { id: 14, sentence: ["Please move us to the meeting room for the next hour."] },
                { id: 15, sentence: ["You must call your doctor to make an appointment."] },
                { id: 16, sentence: ["Please make an appointment with your tutor about work."] },
                { id: 17, sentence: ["Rail transport is becoming more and more popular."] },
                { id: 18, sentence: ["You can keep your bags in the back room."] },
                { id: 19, sentence: ["The weather used to be lovely at this time of the year."] },
                { id: 20, sentence: ["Everyone in this room needs to follow the rules."] },
                { id: 21, sentence: ["I want to make an appointment with the manager.", "I want to make an appointment to see the manager."] },
                { id: 22, sentence: ["The teacher explained the homework to the class."] },
                { id: 23, sentence: ["You should meet me in the lecture theater room."] },
                { id: 24, sentence: ["At that time, few people moved from towns to villages."] },
                { id: 25, sentence: ["Students of the first year usually live on campus."] },
                { id: 26, sentence: ["The fiction books are just past the counter."] },
                { id: 27, sentence: ["The teacher asked the group to complete the task."] },
                { id: 28, sentence: ["There was a lot of traffic jams on the road this morning."] },
                { id: 29, sentence: ["The school canteen sells a large variety of water and food."] },
                { id: 30, sentence: ["Please turn off the lights to save energy.", "Please turn off the light to save energy.", "Please turn off the lights to save the energy.", "Please turn off the light to save the energy."] },
                { id: 31, sentence: ["Traffic is the main cause of pollution in many cities.", "Traffic is the main cause of air pollution in many cities."] },
                { id: 32, sentence: ["You will get your uniform on the first day."] },
                { id: 33, sentence: ["In my opinion, this car should be repaired soon."] },
                { id: 34, sentence: ["We should have a meeting to discuss and report."] },
                { id: 35, sentence: ["Sales figures for last year were better than expected."] },
                { id: 36, sentence: ["The university canteen offers different healthy meal options."] },
                { id: 37, sentence: ["Employment opportunities available in engineering are increasing rapidly."] },
                { id: 38, sentence: ["We cannot consider an increase in price at this stage.", "We can’t consider any increase in our price at this stage."] },
                { id: 39, sentence: ["We should have a meeting to discuss the report."] },
                { id: 40, sentence: ["Our culture influences the choices we make."] },
                { id: 41, sentence: ["There will be a guest lecturer in the next class."] },
                { id: 42, sentence: ["Exam results will be published on the noticeboard."] },
                { id: 43, sentence: ["Atoms are the central building blocks of matter."] },
                { id: 44, sentence: ["There will be a meeting for the first-year students on Friday."] },
                { id: 45, sentence: ["The stairs are to the left of the elevator."] },
                { id: 46, sentence: ["Restrooms are down the entrance and to the right."] },
                { id: 47, sentence: ["Time is needed to complete the lecture."] },
                { id: 48, sentence: ["Restaurants are down to the hall and next to the right."] },
                { id: 49, sentence: ["Make sure you wash your hands before preparing the food."] },
                { id: 50, sentence: ["You should draw your graph on a separate page."] },
                { id: 51, sentence: ["You can ask your tutor for further assistance."] },
                { id: 52, sentence: ["You are trained to be a special journalist."] },
                { id: 53, sentence: ["We can have a lecture on the morning of Thursday."] },
                { id: 54, sentence: ["We can all meet in the office after the lecture."] },
                { id: 55, sentence: ["The digital revolution has changed the way we read."] },
                { id: 56, sentence: ["Before the refrigerator was invented, people used underground ice houses."] },
                { id: 57, sentence: ["The nation achieved prosperity by opening its ports for trade."] },
                { id: 58, sentence: ["Understanding visual media has never been more challenging."] },
                { id: 59, sentence: ["Online courses allow students to work on their own paces."] },
                { id: 60, sentence: ["In my opinion, this car should be repaired soon."] },
                { id: 61, sentence: ["You can get your coffee and tea in the lounge room."] },
                { id: 62, sentence: ["The teacher asked the group to commmence the task."] },
                { id: 63, sentence: ["The island is located at the south end of the bay."] },
                { id: 64, sentence: ["The falling birth rate means the number of students drops."] },
                { id: 65, sentence: ["Please click the logo above to enter the site."] },
                { id: 66, sentence: ["The camera can identify eyes and focus on them."] },
                { id: 67, sentence: ["This article refers to a number of interesting experiments."] },
                { id: 68, sentence: ["You should submit your team papers to the general office."] },
                { id: 69, sentence: ["All students have their own styles of learning."] },
                { id: 70, sentence: ["Stock prediction can be very capricious even for professionals."] },
                { id: 71, sentence: ["New classrooms will be put into use next month."] },
                { id: 72, sentence: ["You need to pass the written exam for the driver's license."] }
            ];

            let currentQuestionIndex = 0;
            let synth = window.speechSynthesis;
            let utterance = new SpeechSynthesisUtterance();
            let voices = [];
            let timerInterval = null;
            let timeLeft = 30;
            let scoreHistory = []; // (新增!) 用于存储历史记录的数组

            // ... (其他元素获取) ...
            const playAudioBtn = document.getElementById('play-audio-btn');
            const retryBtn = document.getElementById('retry-btn');
            const prevQuestionBtn = document.getElementById('prev-question-btn');
            const nextQuestionBtn = document.getElementById('next-question-btn');
            const submitBtn = document.getElementById('submit-btn');
            const userInput = document.getElementById('user-input');
            const resultContainer = document.getElementById('result-container');
            const comparisonResultDiv = document.getElementById('comparison-result');
            const correctAnswerDiv = document.getElementById('correct-answer');
            const currentQuestionIndexSpan = document.getElementById('current-question-index');
            const totalQuestionsSpan = document.getElementById('total-questions');
            const speedControl = document.getElementById('speed-control');
            const speedValueSpan = document.getElementById('speed-value');
            const timerDisplay = document.getElementById('timer-display');
            const scoreDisplay = document.getElementById('score-display');
            const totalScoreDisplay = document.getElementById('total-score-display');
            const copyrightYearSpan = document.getElementById('copyright-year');
            const historyList = document.getElementById('history-list'); // (新增!) 历史列表元素

            // (新增!) 从localStorage加载历史记录
            function loadHistoryFromStorage() {
                const savedHistory = localStorage.getItem('wfdScoreHistory');
                if (savedHistory) {
                    scoreHistory = JSON.parse(savedHistory);
                }
            }

            // (新增!) 保存历史记录到localStorage
            function saveHistoryToStorage() {
                localStorage.setItem('wfdScoreHistory', JSON.stringify(scoreHistory));
            }

            // (新增!) 渲染历史记录列表
            function renderHistory() {
                historyList.innerHTML = ''; // 清空列表
                if (scoreHistory.length === 0) {
                    historyList.innerHTML = `<li class="text-slate-400 text-center py-4">暂无练习记录</li>`;
                    return;
                }
                // 从新到旧显示
                scoreHistory.slice().reverse().forEach(entry => {
                    const li = document.createElement('li');
                    li.className = `p-3 rounded-lg flex justify-between items-center ${entry.score === entry.totalScore ? 'bg-green-50' : 'bg-red-50'}`;

                    const scoreColor = entry.score === entry.totalScore ? 'text-green-700' : 'text-red-700';

                    li.innerHTML = `
                            <div>
                                <span class="font-bold text-slate-700">第 ${entry.questionId} 题</span>
                                <span class="block text-xs text-slate-500">${new Date(entry.timestamp).toLocaleString('zh-CN')}</span>
                            </div>
                            <span class="text-xl font-extrabold ${scoreColor}">${entry.score}/${entry.totalScore}</span>
                        `;
                    historyList.appendChild(li);
                });
            }

            function initialize() {
                loadHistoryFromStorage(); // (新增!)
                renderHistory(); // (新增!)
                loadVoices();
                loadQuestion(currentQuestionIndex);
                totalQuestionsSpan.textContent = wfdSentences.length;
                copyrightYearSpan.textContent = new Date().getFullYear();

                if (synth.onvoiceschanged !== undefined) {
                    synth.onvoiceschanged = loadVoices;
                }
            }

            // ... (loadVoices, loadQuestion, startTimer, stopTimer, updateSpeechRate 函数保持不变) ...
            function loadVoices() {
                voices = synth.getVoices();
                const preferredVoice = voices.find(voice => voice.name.includes('Google') && voice.lang.startsWith('en')) || voices.find(voice => voice.lang.startsWith('en-US'));
                if (preferredVoice) utterance.voice = preferredVoice;
                utterance.pitch = 1;
                updateSpeechRate();
            }

            function loadQuestion(index) {
                stopTimer();
                const question = wfdSentences[index];
                utterance.text = question.sentence[0];
                userInput.value = '';
                userInput.disabled = false;
                resultContainer.classList.add('hidden');
                currentQuestionIndexSpan.textContent = index + 1;
                userInput.focus();
            }

            function startTimer() {
                stopTimer();
                timeLeft = 30;
                timerDisplay.textContent = timeLeft;
                timerDisplay.classList.remove('urgent');

                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    if (timeLeft <= 10) {
                        timerDisplay.classList.add('urgent');
                    }
                    if (timeLeft <= 0) {
                        stopTimer();
                        submitBtn.click();
                    }
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
                timerInterval = null;
                timerDisplay.textContent = 30;
                timerDisplay.classList.remove('urgent');
            }

            function updateSpeechRate() {
                const rate = parseFloat(speedControl.value);
                utterance.rate = rate;
                speedValueSpan.textContent = `${rate.toFixed(1)}x`;
            }

            function compareAnswers() {
                stopTimer();
                userInput.disabled = true;

                const question = wfdSentences[currentQuestionIndex];
                const userText = userInput.value;
                const normalize = (text) => text.trim().split(/\s+/).filter(Boolean);
                const userWords = normalize(userText);

                let bestScore = -1;
                let bestComparison = {};

                for (const correctText of question.sentence) {
                    const correctWords = normalize(correctText);
                    let score = 0;
                    let correctWordsPool = [...correctWords];

                    for (const userWord of userWords) {
                        const matchIndex = correctWordsPool.indexOf(userWord);
                        if (matchIndex !== -1) {
                            score++;
                            correctWordsPool.splice(matchIndex, 1);
                        }
                    }

                    if (score > bestScore) {
                        bestScore = score;
                        bestComparison = {
                            score: score,
                            totalScore: correctWords.length,
                            correctText: correctText,
                        };
                    }
                }

                scoreDisplay.textContent = bestComparison.score;
                totalScoreDisplay.textContent = bestComparison.totalScore;
                correctAnswerDiv.textContent = bestComparison.correctText;

                // (新增!) 将结果添加到历史记录
                const historyEntry = {
                    questionId: currentQuestionIndex + 1,
                    score: bestComparison.score,
                    totalScore: bestComparison.totalScore,
                    timestamp: new Date().toISOString()
                };
                scoreHistory.push(historyEntry);
                saveHistoryToStorage();
                renderHistory();

                // ... (生成对比结果的HTML逻辑保持不变) ...
                const correctWordsForDiff = normalize(bestComparison.correctText);
                let resultHTML = '';
                const correctWordMatched = correctWordsForDiff.map(() => false);

                const userWordsWithStatus = userWords.map(uWord => {
                    const matchIndex = correctWordsForDiff.findIndex((cWord, index) => !correctWordMatched[index] && cWord === uWord);
                    if (matchIndex !== -1) {
                        correctWordMatched[matchIndex] = true;
                        return { word: uWord, status: 'correct' };
                    }
                    return { word: uWord, status: 'incorrect' };
                });

                userWordsWithStatus.forEach(item => {
                    resultHTML += `<span class="word-${item.status}">${item.word}</span>`;
                });

                correctWordsForDiff.forEach((word, index) => {
                    if (!correctWordMatched[index]) {
                        resultHTML += `<span class="word-missing">${word} (遗漏)</span>`;
                    }
                });

                comparisonResultDiv.innerHTML = resultHTML || "<span>(您没有输入任何内容)</span>";
                resultContainer.classList.remove('hidden');
            }

            // ... (其他事件监听器保持不变) ...
            function playCurrentAudio() {
                if (synth.speaking) synth.cancel();

                playAudioBtn.classList.add('pulse-once');
                setTimeout(() => playAudioBtn.classList.remove('pulse-once'), 800);

                utterance.onend = () => {
                    startTimer();
                    userInput.focus();
                };
                synth.speak(utterance);
            }

            function navigateAndPlay(direction) {
                if (direction === 'next') {
                    currentQuestionIndex = (currentQuestionIndex + 1) % wfdSentences.length;
                } else {
                    currentQuestionIndex = (currentQuestionIndex - 1 + wfdSentences.length) % wfdSentences.length;
                }
                loadQuestion(currentQuestionIndex);

                const buttons = [playAudioBtn, retryBtn, prevQuestionBtn, nextQuestionBtn];
                buttons.forEach(btn => btn.disabled = true);

                setTimeout(() => {
                    playCurrentAudio();
                    buttons.forEach(btn => btn.disabled = false);
                }, 1000);
            }

            playAudioBtn.addEventListener('click', playCurrentAudio);
            retryBtn.addEventListener('click', () => {
                loadQuestion(currentQuestionIndex);
                playCurrentAudio();
            });
            prevQuestionBtn.addEventListener('click', () => navigateAndPlay('prev'));
            nextQuestionBtn.addEventListener('click', () => navigateAndPlay('next'));
            speedControl.addEventListener('input', updateSpeechRate);
            submitBtn.addEventListener('click', compareAnswers);
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitBtn.click();
                }
            });

            initialize();
            lucide.createIcons();
        });
    </script>
</body>
</html>

