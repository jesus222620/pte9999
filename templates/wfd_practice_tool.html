<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级WFD默写教练</title>
    <!-- 引入Tailwind CSS 用于美化界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Lucide图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 自定义动画和样式 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .comparison-result span {
            padding: 4px 6px;
            border-radius: 4px;
            margin: 2px;
            display: inline-block;
            font-size: 1.1rem;
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .word-correct {
            background-color: #dcfce7;
            color: #166534;
        }

        .word-incorrect {
            background-color: #fee2e2;
            color: #991b1b;
            text-decoration: line-through;
        }

        .word-missing {
            background-color: #e0e7ff;
            color: #4338ca;
            border: 1px dashed #6366f1;
        }

        @keyframes pulse-animation {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(99, 102, 241, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        .pulse-once {
            animation: pulse-animation 0.8s ease-out;
        }

        #timer-display {
            transition: color 0.5s, transform 0.5s;
        }

            #timer-display.urgent {
                color: #dc2626;
                transform: scale(1.1);
                animation: blink 1s infinite;
            }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen font-sans">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl p-8 m-4 relative">

        <div class="text-center border-b pb-4 mb-6">
            <h1 class="text-3xl font-extrabold text-slate-800">高级WFD默写教练</h1>
            <p class="text-slate-500 mt-2">智能识别多种答案、支持重练、带倒计时</p>
        </div>

        <!-- 控制区域 -->
        <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4 mb-6">
            <!-- 播放和题目控制 -->
            <div class="flex items-center justify-center md:justify-start gap-2">
                <button id="play-audio-btn" class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all transform hover:scale-105" title="播放本题音频">
                    <i data-lucide="play-circle"></i><span>播放</span>
                </button>
                <button id="retry-btn" class="flex items-center justify-center gap-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all transform hover:scale-105" title="重来本题">
                    <i data-lucide="rotate-cw"></i><span>重来</span>
                </button>
                <button id="next-question-btn" class="flex items-center justify-center gap-2 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all transform hover:scale-105" title="下一题">
                    <span>下一题</span><i data-lucide="arrow-right-circle"></i>
                </button>
            </div>
            <!-- 速度和倒计时 -->
            <div class="flex items-center justify-center gap-6">
                <div class="flex items-center gap-2">
                    <i data-lucide="gauge-circle" class="text-slate-500"></i>
                    <label for="speed-control" class="text-slate-600 font-medium">语速:</label>
                    <input id="speed-control" type="range" min="0.7" max="1.3" value="0.9" step="0.1" class="w-24 cursor-pointer">
                    <span id="speed-value" class="font-bold text-indigo-600 w-8">0.9x</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="timer" class="text-slate-500"></i>
                    <span class="text-slate-600 font-medium">倒计时:</span>
                    <span id="timer-display" class="font-bold text-2xl text-slate-800 w-12 text-center">30</span>
                </div>
            </div>
            <!-- 题目计数 -->
            <div class="text-sm text-slate-500 text-center md:text-right">
                当前题目: <span id="current-question-index" class="font-bold">1</span> / <span id="total-questions" class="font-bold">0</span>
            </div>
        </div>

        <div class="mb-6">
            <textarea id="user-input" rows="4" class="w-full p-4 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 transition" placeholder="请在此处输入你听到的句子..."></textarea>
        </div>

        <button id="submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg text-lg shadow-xl transition-all transform hover:scale-105">
            提交答案并对比
        </button>

        <div id="result-container" class="mt-8 hidden">
            <div class="border-t pt-6">
                <div class="text-center mb-6 fade-in">
                    <h3 class="text-2xl font-bold text-slate-700">你的得分</h3>
                    <p class="text-6xl font-extrabold text-indigo-600 mt-2">
                        <span id="score-display">0</span> / <span id="total-score-display">0</span>
                    </p>
                </div>
                <div class="fade-in" style="animation-delay: 0.2s;">
                    <h3 class="text-xl font-bold text-slate-700 mb-4">对比结果 (已匹配最佳答案)</h3>
                    <div id="comparison-result" class="p-4 bg-slate-50 rounded-lg comparison-result"></div>
                </div>
                <div class="fade-in" style="animation-delay: 0.4s;">
                    <h3 class="text-xl font-bold text-slate-700 mt-6 mb-4">标准答案参考</h3>
                    <div id="correct-answer" class="p-4 bg-slate-50 rounded-lg text-slate-800 font-semibold text-lg"></div>
                </div>
            </div>
        </div>

        <footer class="text-center text-xs text-slate-400 mt-8 pt-4 border-t">
            <p>&copy; <span id="copyright-year"></span> pte9999. All Rights Reserved.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 题库 ---
            // displaySentence: 用于朗读和最终展示的标准答案
            // validAnswers: 所有可以被接受为正确答案的变体
            const wfdSentences = [
                { id: 1, displaySentence: "Please get us a meeting room for the next hour.", validAnswers: ["Please get us a meeting room for the next hour."] },
                { id: 2, displaySentence: "Communication skills have become more important in recent years.", validAnswers: ["Communication skills have become more important in recent years."] },
                { id: 3, displaySentence: "Before preparing any food, be sure to wash your hands well.", validAnswers: ["Before preparing any food, be sure to wash your hands well."] },
                { id: 4, displaySentence: "Before preparing food, please make sure to wash your hands.", validAnswers: ["Before preparing food, please make sure to wash your hands."] },
                { id: 5, displaySentence: "The weather has been lovely from this time of the year.", validAnswers: ["The weather has been lovely from this time of the year."] },
                { id: 6, displaySentence: "Please close the door behind you when you leave the room.", validAnswers: ["Please close the door behind you when you leave the room."] },
                { id: 7, displaySentence: "There was a lot of traffic this morning.", validAnswers: ["There was a lot of traffic this morning."] },
                { id: 8, displaySentence: "The restroom is down the hall and on the right.", validAnswers: ["The restroom is down the hall and on the right.", "The restrooms are down the hall to the right."] },
                { id: 9, displaySentence: "The teacher explains the homework to the students.", validAnswers: ["The teacher explains the homework to the students."] },
                { id: 10, displaySentence: "At that time, few people moved from towns to villages.", validAnswers: ["At that time, few people moved from towns to villages.", "At that time, few people moved through the town to the village."] },
                { id: 11, displaySentence: "The fiction books have just passed to the counter.", validAnswers: ["The fiction books have just passed to the counter."] },
                { id: 12, displaySentence: "You have to make an appointment with your doctor.", validAnswers: ["You have to make an appointment with your doctor."] },
                { id: 13, displaySentence: "The students will meet their new teacher after summer vacation.", validAnswers: ["The students will meet their new teacher after summer vacation."] },
                { id: 14, displaySentence: "Please move us to the meeting room for the next hour.", validAnswers: ["Please move us to the meeting room for the next hour."] },
                { id: 15, displaySentence: "You must call your doctor to make an appointment.", validAnswers: ["You must call your doctor to make an appointment."] },
                { id: 16, displaySentence: "Please make an appointment with your tutor about work.", validAnswers: ["Please make an appointment with your tutor about work."] },
                { id: 17, displaySentence: "Rail transport is becoming more and more popular.", validAnswers: ["Rail transport is becoming more and more popular."] },
                { id: 18, displaySentence: "You can keep your bags in the back room.", validAnswers: ["You can keep your bags in the back room."] },
                { id: 19, displaySentence: "The weather used to be lovely at this time of the year.", validAnswers: ["The weather used to be lovely at this time of the year."] },
                { id: 20, displaySentence: "Everyone in this room needs to follow the rules.", validAnswers: ["Everyone in this room needs to follow the rules."] },
                { id: 21, displaySentence: "I want to make an appointment with the manager.", validAnswers: ["I want to make an appointment with the manager.", "I want to make an appointment to see the manager."] },
                { id: 22, displaySentence: "The teacher explained the homework to the class.", validAnswers: ["The teacher explained the homework to the class."] },
                { id: 23, displaySentence: "You should meet me in the lecture theater room.", validAnswers: ["You should meet me in the lecture theater room."] },
                { id: 24, displaySentence: "At that time, few people moved from towns to villages.", validAnswers: ["At that time, few people moved from towns to villages."] },
                { id: 25, displaySentence: "Students of the first year usually live on campus.", validAnswers: ["Students of the first year usually live on campus."] },
                { id: 26, displaySentence: "The fiction books are just past the counter.", validAnswers: ["The fiction books are just past the counter."] },
                { id: 27, displaySentence: "The teacher asked the group to complete the task.", validAnswers: ["The teacher asked the group to complete the task."] },
                { id: 28, displaySentence: "There was a lot of traffic jams on the road this morning.", validAnswers: ["There was a lot of traffic jams on the road this morning."] },
                { id: 29, displaySentence: "The school canteen sells a large variety of water and food.", validAnswers: ["The school canteen sells a large variety of water and food."] },
                { id: 30, displaySentence: "Please turn off the lights to save energy.", validAnswers: ["Please turn off the lights to save energy.", "Please turn off the light to save energy.", "Please turn off the lights to save the energy.", "Please turn off the light to save the energy."] },
                { id: 31, displaySentence: "Traffic is the main cause of air pollution in many cities.", validAnswers: ["Traffic is the main cause of air pollution in many cities.", "Traffic is the main cause of pollution in many cities."] },
                { id: 32, displaySentence: "You will get your uniform on the first day.", validAnswers: ["You will get your uniform on the first day."] },
                { id: 33, displaySentence: "In my opinion, this car should be repaired soon.", validAnswers: ["In my opinion, this car should be repaired soon."] },
                { id: 34, displaySentence: "We should have a meeting to discuss and report.", validAnswers: ["We should have a meeting to discuss and report."] },
                { id: 35, displaySentence: "Sales figures for last year were better than expected.", validAnswers: ["Sales figures for last year were better than expected."] },
                { id: 36, displaySentence: "The university canteen offers different healthy meal options.", validAnswers: ["The university canteen offers different healthy meal options."] },
                { id: 37, displaySentence: "Employment opportunities available in engineering are increasing rapidly.", validAnswers: ["Employment opportunities available in engineering are increasing rapidly."] },
                { id: 38, displaySentence: "We cannot consider an increase in price at this stage.", validAnswers: ["We cannot consider an increase in price at this stage.", "We can’t consider any increase in our price at this stage."] },
                { id: 39, displaySentence: "We should have a meeting to discuss the report.", validAnswers: ["We should have a meeting to discuss the report."] },
                { id: 40, displaySentence: "Our culture influences the choices we make.", validAnswers: ["Our culture influences the choices we make."] },
                { id: 41, displaySentence: "There will be a guest lecturer in the next class.", validAnswers: ["There will be a guest lecturer in the next class."] },
                { id: 42, displaySentence: "Exam results will be published on the noticeboard.", validAnswers: ["Exam results will be published on the noticeboard."] },
                { id: 43, displaySentence: "Atoms are the central building blocks of matter.", validAnswers: ["Atoms are the central building blocks of matter."] },
                { id: 44, displaySentence: "There will be a meeting for the first-year students on Friday.", validAnswers: ["There will be a meeting for the first-year students on Friday."] },
                { id: 45, displaySentence: "The stairs are to the left of the elevator.", validAnswers: ["The stairs are to the left of the elevator."] },
                { id: 46, displaySentence: "Restrooms are down the entrance and to the right.", validAnswers: ["Restrooms are down the entrance and to the right."] },
                { id: 47, displaySentence: "Time is needed to complete the lecture.", validAnswers: ["Time is needed to complete the lecture."] },
                { id: 48, displaySentence: "Restaurants are down to the hall and next to the right.", validAnswers: ["Restaurants are down to the hall and next to the right."] },
                { id: 49, displaySentence: "Make sure you wash your hands before preparing the food.", validAnswers: ["Make sure you wash your hands before preparing the food."] },
                { id: 50, displaySentence: "You should draw your graph on a separate page.", validAnswers: ["You should draw your graph on a separate page."] },
                { id: 51, displaySentence: "You can ask your tutor for further assistance.", validAnswers: ["You can ask your tutor for further assistance."] },
                { id: 52, displaySentence: "You are trained to be a special journalist.", validAnswers: ["You are trained to be a special journalist."] },
                { id: 53, displaySentence: "We can have a lecture on the morning of Thursday.", validAnswers: ["We can have a lecture on the morning of Thursday."] },
                { id: 54, displaySentence: "We can all meet in the office after the lecture.", validAnswers: ["We can all meet in the office after the lecture."] },
                { id: 55, displaySentence: "The digital revolution has changed the way we read.", validAnswers: ["The digital revolution has changed the way we read."] },
                { id: 56, displaySentence: "Before the refrigerator was invented, people used underground ice houses.", validAnswers: ["Before the refrigerator was invented, people used underground ice houses."] },
                { id: 57, displaySentence: "The nation achieved prosperity by opening its ports for trade.", validAnswers: ["The nation achieved prosperity by opening its ports for trade."] },
                { id: 58, displaySentence: "Understanding visual media has never been more challenging.", validAnswers: ["Understanding visual media has never been more challenging."] },
                { id: 59, displaySentence: "Online courses allow students to work on their own paces.", validAnswers: ["Online courses allow students to work on their own paces."] },
                { id: 60, displaySentence: "In my opinion, this car should be repaired soon.", validAnswers: ["In my opinion, this car should be repaired soon."] },
                { id: 61, displaySentence: "You can get your coffee and tea in the lounge room.", validAnswers: ["You can get your coffee and tea in the lounge room."] },
                { id: 62, displaySentence: "The teacher asked the group to commmence the task.", validAnswers: ["The teacher asked the group to commmence the task."] },
                { id: 63, displaySentence: "The island is located at the south end of the bay.", validAnswers: ["The island is located at the south end of the bay."] },
                { id: 64, displaySentence: "The falling birth rate means the number of students drops.", validAnswers: ["The falling birth rate means the number of students drops."] },
                { id: 65, displaySentence: "Please click the logo above to enter the site.", validAnswers: ["Please click the logo above to enter the site."] },
                { id: 66, displaySentence: "The camera can identify eyes and focus on them.", validAnswers: ["The camera can identify eyes and focus on them."] },
                { id: 67, displaySentence: "This article refers to a number of interesting experiments.", validAnswers: ["This article refers to a number of interesting experiments."] },
                { id: 68, displaySentence: "You should submit your team papers to the general office.", validAnswers: ["You should submit your team papers to the general office."] },
                { id: 69, displaySentence: "All students have their own styles of learning.", validAnswers: ["All students have their own styles of learning."] },
                { id: 70, displaySentence: "Stock prediction can be very capricious even for professionals.", validAnswers: ["Stock prediction can be very capricious even for professionals."] },
                { id: 71, displaySentence: "New classrooms will be put into use next month.", validAnswers: ["New classrooms will be put into use next month."] },
                { id: 72, displaySentence: "You need to pass the written exam for the driver's license.", validAnswers: ["You need to pass the written exam for the driver's license."] }
            ];

            let currentQuestionIndex = 0;
            let synth = window.speechSynthesis;
            let utterance = new SpeechSynthesisUtterance();
            let voices = [];
            let timerInterval = null;
            let timeLeft = 30;

            const playAudioBtn = document.getElementById('play-audio-btn');
            const retryBtn = document.getElementById('retry-btn');
            const nextQuestionBtn = document.getElementById('next-question-btn');
            const submitBtn = document.getElementById('submit-btn');
            const userInput = document.getElementById('user-input');
            const resultContainer = document.getElementById('result-container');
            const comparisonResultDiv = document.getElementById('comparison-result');
            const correctAnswerDiv = document.getElementById('correct-answer');
            const currentQuestionIndexSpan = document.getElementById('current-question-index');
            const totalQuestionsSpan = document.getElementById('total-questions');
            const speedControl = document.getElementById('speed-control');
            const speedValueSpan = document.getElementById('speed-value');
            const timerDisplay = document.getElementById('timer-display');
            const scoreDisplay = document.getElementById('score-display');
            const totalScoreDisplay = document.getElementById('total-score-display');
            const copyrightYearSpan = document.getElementById('copyright-year');

            function initialize() {
                loadVoices();
                loadQuestion(currentQuestionIndex);
                totalQuestionsSpan.textContent = wfdSentences.length;
                copyrightYearSpan.textContent = new Date().getFullYear();

                if (synth.onvoiceschanged !== undefined) {
                    synth.onvoiceschanged = loadVoices;
                }
            }

            function loadVoices() {
                voices = synth.getVoices();
                const preferredVoice = voices.find(voice => voice.name === 'Google US English') || voices.find(voice => voice.lang === 'en-US');
                if (preferredVoice) utterance.voice = preferredVoice;
                utterance.pitch = 1;
                updateSpeechRate();
            }

            function loadQuestion(index) {
                stopTimer();
                const question = wfdSentences[index];
                utterance.text = question.displaySentence;
                userInput.value = '';
                userInput.disabled = false;
                resultContainer.classList.add('hidden');
                currentQuestionIndexSpan.textContent = index + 1;
                userInput.focus();
            }

            function startTimer() {
                stopTimer();
                timeLeft = 30;
                timerDisplay.textContent = timeLeft;
                timerDisplay.classList.remove('urgent');

                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    if (timeLeft <= 10) {
                        timerDisplay.classList.add('urgent');
                    }
                    if (timeLeft <= 0) {
                        stopTimer();
                        submitBtn.click();
                    }
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
                timerInterval = null;
                timerDisplay.textContent = 30;
                timerDisplay.classList.remove('urgent');
            }

            function updateSpeechRate() {
                const rate = parseFloat(speedControl.value);
                utterance.rate = rate;
                speedValueSpan.textContent = `${rate.toFixed(1)}x`;
            }

            // --- 核心评分与对比逻辑 ---
            function compareAnswers() {
                stopTimer();
                userInput.disabled = true;

                const userText = userInput.value;
                const question = wfdSentences[currentQuestionIndex];

                let bestMatch = {
                    score: -1,
                    html: '',
                    correctWords: []
                };

                const normalize = (text) => text.toLowerCase().replace(/[.,'’?!]/g, '').trim().split(/\s+/).filter(Boolean);
                const userWords = normalize(userText);

                // 遍历所有可能的正确答案，找到得分最高的一个
                for (const validAnswer of question.validAnswers) {
                    const correctWords = normalize(validAnswer);
                    let currentScore = 0;
                    let correctWordsPool = [...correctWords];

                    // 计算得分
                    for (const userWord of userWords) {
                        const matchIndex = correctWordsPool.indexOf(userWord);
                        if (matchIndex !== -1) {
                            currentScore++;
                            correctWordsPool.splice(matchIndex, 1);
                        }
                    }

                    // 如果当前得分更高，则更新最佳匹配
                    if (currentScore > bestMatch.score) {
                        bestMatch.score = currentScore;
                        bestMatch.correctWords = correctWords;

                        // --- 生成对比结果HTML ---
                        // 这是一个简化的diff算法，用于生成美观的对比结果
                        let resultHtml = '';
                        let tempUserWords = [...userWords];
                        correctWords.forEach(correctWord => {
                            const userMatchIndex = tempUserWords.indexOf(correctWord);
                            if (userMatchIndex !== -1) {
                                // 处理匹配词之前的所有错误词
                                for (let i = 0; i < userMatchIndex; i++) {
                                    resultHtml += `<span class="word-incorrect">${tempUserWords[i]}</span>`;
                                }
                                // 处理匹配词
                                resultHtml += `<span class="word-correct">${correctWord}</span>`;
                                // 移除已处理的用户词
                                tempUserWords.splice(0, userMatchIndex + 1);
                            } else {
                                // 未匹配，标记为遗漏
                                resultHtml += `<span class="word-missing">${correctWord} (遗漏)</span>`;
                            }
                        });

                        // 将剩余未匹配的用户词标记为错误
                        tempUserWords.forEach(extraWord => {
                            resultHtml += `<span class="word-incorrect">${extraWord}</span>`;
                        });
                        bestMatch.html = resultHtml;
                    }
                }

                // --- 显示最佳结果 ---
                scoreDisplay.textContent = bestMatch.score;
                totalScoreDisplay.textContent = bestMatch.correctWords.length;
                comparisonResultDiv.innerHTML = bestMatch.html;
                correctAnswerDiv.textContent = question.displaySentence; // 始终显示标准答案
                resultContainer.classList.remove('hidden');
            }


            playAudioBtn.addEventListener('click', () => {
                if (synth.speaking) synth.cancel();

                playAudioBtn.classList.add('pulse-once');
                setTimeout(() => playAudioBtn.classList.remove('pulse-once'), 800);

                utterance.onend = () => {
                    startTimer();
                    userInput.focus();
                };
                synth.speak(utterance);
            });

            retryBtn.addEventListener('click', () => {
                loadQuestion(currentQuestionIndex);
                setTimeout(() => playAudioBtn.click(), 100); // 稍作延迟以确保状态重置
            });

            nextQuestionBtn.addEventListener('click', () => {
                currentQuestionIndex = (currentQuestionIndex + 1) % wfdSentences.length;
                loadQuestion(currentQuestionIndex);
            });

            speedControl.addEventListener('input', updateSpeechRate);

            submitBtn.addEventListener('click', compareAnswers);

            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitBtn.click();
                }
            });

            initialize();
            lucide.createIcons();
        });
    </script>
</body>
</html>
